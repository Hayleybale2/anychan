# `2ch.hk` API

## Определения

### Board

Полная информация о доске.

```js
{
  // ID доски.
  "Board": "vg",
  "BoardInfo": "Доска для постоянных тредов по игре",
  "BoardInfoOuter": "Видеоигры, general, официальные треды", // хз
  // Название доски.
  "BoardName": "Video Games General",

  // Рекламный баннер сверху.
  "advert_top_image": "/banners/bDpQCWt8xPTuC43S.jpg",
  // Рекламный баннер сверху.
  "advert_top_link": "/banners/bDpQCWt8xPTuC43S/",

  // Рекламный баннер снизу.
  "advert_bottom_image": "/banners/AZMtfxdMbkGwpPXB.jpg",
  // Ссылка рекламного баннера снизу.
  "advert_bottom_link": "/banners/AZMtfxdMbkGwpPXB/",

  // Рекламный баннер (мобильные устройства).
  "advert_mobile_image": "/banners/S4BcqS4adse3B2Cb.jpg",
  // Рекламный баннер (мобильные устройства).
  "advert_mobile_link": "/banners/S4BcqS4adse3B2Cb/",

  // Сколько постов можно написать в тред данной доски
  // до тех пор, пока тред не перестанет от них "бампаться" (подниматься).
  "bump_limit": 1000,

  // Имя автора поста по умолчанию.
  "default_name": "Аноним",

  "enable_dices": 0,
  "enable_flags": 0, // Показываются ли флаги у постов треда.
  "enable_icons": 0,
  "enable_images": 1, // Видимо, можно ли прикреплять к постам картинки.
  "enable_likes": 0, // Ставятся ли в этом треде лайки/дизлайки.
  "enable_names": 0,
  "enable_oekaki": 0, // Видимо, можно ли рисовать "oekaki".
  "enable_posting": 1, // Видимо, можно ли постить на этой доске.
  "enable_sage": 0, // Видимо, можно ли "сагать" на этой доске (ответ с "сажей" ("sage", см. ниже) не "бампает" тред).
  "enable_shield": 0,
  "enable_subject": 1, // Показывать ли поле "Тема" в форме отправки сообщения или создания треда.
  "enable_thread_tags": 1, // Видимо, можно ли помечать треды тегами.
  "enable_trips": 0, // Разрешены ли "трип-коды" на доске.
  "enable_video": 1, // Видимо, можно ли прикреплять к постам видео.

  // Максимальная длина комментария.
  "max_comment": 15000,
  // Максимальный размер прикрепляемого файла.
  "max_files_size": 40960,
  // ID самого "последнего" (на текущий момент) поста в треде.
  "max_num": 3489385,

  // Баннер случайной доски.
  "board_banner_image": "/ololo/kpop_7.gif",
  // Ссылка баннера случайной доски.
  "board_banner_link": "kpop",

  // `0` для API тредов, `1` для API досок.
  "is_board": 0,
  // `1`, если это ответ на API постраничного списка тредов доски.
  "is_index": 0,
}
```

### Post

```js
{
  // ID поста.
  "num": 29102706,

  // Дата написания поста ("unix time").
  "timestamp": 1549035324,

  // "Человекочитаемая" дата написания поста.
  "date": "01/02/19 Птн 18:35:24",

  // Если "1", то данный пост написан человеком,
  // создавшим тред с галкой "ОП треда",
  // и запостившим это сообщения с галкой "ОП треда".
  "op": 0,

  // Имя автора поста.
  "name": "Аноним",

  // "email" автора поста (с префиксом "mailto:").
  // Пример: "mailto:admin@example.com".
  "email": "",

  // "Трип-код" автора поста.
  // Для администраторов и модераторов тут ставится соответствующая метка.
  "trip": "",
  "subject": "Четырнадцатый двачкап", // "Тема" поста.
  "comment": "Скинул на почту", // HTML-код комментария.
  "files": [], // Список объектов типа `Attachment`.

  // Забанен ли автор поста за данный пост.
  "banned": 0,

  // Закрыт ли этот тред.
  "closed": 0,

  // Является ли тред "бесконечным".
  // "Бесконечный" тред — это тред, не имеющий "бамплимита"
  // ("бампается" при любом ответе в нём), но при этом максимальное
  // количество постов в треде ограничено бамплимитом доски (например, 500 шт.),
  // и при добавлении в тред новых постов наиболее старые из существующих автоматически удаляются.
  "endless": 0,

  // `timestamp` комментария, который является
  // (на текущее время) "последним", "бампающим" данный тред.
  // Например, первый комментарий в треде, или 500-ый комментарий
  // в треде с "бамп-лимитом" в 500 и количеством постов больше 500.
  // Одно и то же значение у всех постов треда.
  "lasthit": 1549117714,

  // Закреплён ли этот тред наверху в списке тредов доски.
  // Если не `0`, то может быть как `1`, так и любое другое целое положительное число.
  // (хз, какой смысл это может нести).
  "sticky": 0,

  // (только у первого поста треда)
  // Теги треда. Пустая строка, если не указано тегов.
  "tags": "lolcup",

  // id треда данного поста (в виде строки).
  // "0" для первого поста треда, для остальных постов —
  // одно и то же значение: id треда, он же id первого поста треда.
  "parent": "0",

  // (optional)
  // Только для тредов с "лайками":
  "likes": 1, // Количество "лайков" у поста.
  "dislikes": 1, // Количество "дизлайков" у поста.
}
```

### Thread

id треда — это id первого поста треда.

```js
{
  "posts": [] // Список объектов типа `Post`.
}
```

### Attachment

Картинка или видео, прикреплённые к посту.

```js
{
  // Тип файла (1 — jpeg, 2 — png, 4 — gif, 6 - webm, 10 — mp4, 100 — png стикер).
  "type": 2,
  // Помечена ли эта картинка как "NSFW" ("18+").
  "nsfw": 0,
  // Размер картинки или видео в килобайтах.
  "size": 1611,

  // Ширина картинки или видео.
  "width": 1363,
  // Высота картинки или видео.
  "height": 768,

  // Имя файла (ограниченное по длине).
  "displayname": "photo2018-10-27[...]..png",
  // Имя файла.
  "fullname": "photo2018-10-2705-29-50.png",
  // Имя файла на сервере.
  "name": "15490353246680.png",
  // URL картинки или видео.
  "path": "/vg/src/29102706/15490353246680.png",

  // MD5 хеш файла.
  "md5": "bc441048422b76dd41d626e1420fa0f7",

  // URL уменьшенной картинки.
  "thumbnail": "/vg/thumb/29102706/15490353246680s.jpg",
  // Ширина уменьшенной картинки.
  "tn_width": 250,
  // Высота уменьшенной картинки.
  "tn_height": 140,

  // (только для видео)
  // "Человекочитаемая" длительность видео.
  "duration": "00:00:53",
  // (только для видео)
  // Длительность видео в секундах.
  "duration_secs": 53
}
```

## Синтаксис

HTML синтаксис сообщений:

* `<strong>...</strong>` — жирный текст.
* `<em>...</em>` — курсивный текст.
* `<b>...</b>` — жирный текст (иногда бывает и такой, если кто-то вручную пишет HTML код: например, модераторы в "закреплённых" постах).
* `<i>...</i>` — жирный текст (иногда бывает и такой, если кто-то вручную пишет HTML код: например, модераторы в "закреплённых" постах).
* `<sub>...</sub>` — нижний индекс.
* `<sup>...</sup>` — верхний индекс.
* `<span class="s">...</span>` — зачёркнутый текст.
* `<span class="u">...</span>` — подчёркнутый текст.
* `<span class="o">...</span>` — надчёркнутый текст.
* `<span class="spoiler">...</span>` — спойлер.
* `<span class="unkfunc">...</span>` — цитируемый текст (начинается с `>`).
* `<div class="quote">...</div>` — возможно, ещё один вариант цитируемого текста (хз, где я его видел).
* `<a href="..." data-thread="12345" data-num="12367">...</a>` — ссылка на сообщение (`data-thread` — ID треда, `data-num` — ID поста) (начинается с `>>`).
* Также модераторы имеют полномочия писать на чистом HTML коде (например, в "прикреплённых" сообщениях), и возможны любые теги, например: `<div/>`, `<p/>`, `<h1/>`, `<style/>`, `<script/>`, `<table/>`, `<tr/>`, `<td/>`, и тому подобные, так что любые нестандартные/невалидные теги следует игнорировать, просто показывая их содержимое (которое, в свою очередь, также может содержать нестандартные/невалидные теги).

## Адреса API

### Список постов треда

`https://2ch.hk/<доска>/res/<номер-треда>.json`

```js
{
  // Содержит все свойства объекта `Board`.

  "current_thread": "12345", // id запрошенного треда.
  "posts_count": 123, // Количество постов в треде.
  "files_count": 3, // Сколько файлов запощено в тред суммарно.
  "unique_posters": 7, // Возможно, количество уникальных пользователей, написавших комментарий в треде.
  "icons": [], // хз
  "is_closed": 0, // `1`, если тред закрыт.

  "title": "...", // Название треда. Видимо, то же самое, что `posts[0].subject`.

  "threads": [{
    // Список объектов типа `post`.
    "posts": [
      {
        // Содержит все поля объекта `post`.

        "number": 1, // Порядковый номер поста в треде, начиная с `1`.
      },
      ...
    ]
  }]
}
```

### Список постов треда, начиная с id поста

[`https://2ch.hk/makaba/mobile.fcgi?task=get_thread&board=abu&thread=1&num=1`](https://2ch.hk/makaba/mobile.fcgi?task=get_thread&board=abu&thread=1&num=1)

Параметры:

* `board` — id доски.
* `thread` — id треда.
* `num` — id поста, начиная с корого будет список постов в ответе.

Ответ: Список объектов типа [`Post`](#post).

### Список постов треда, начиная с порядкового номера поста в треде

[`https://2ch.hk/makaba/mobile.fcgi?task=get_thread&board=abu&thread=39220&post=252`](https://2ch.hk/makaba/mobile.fcgi?task=get_thread&board=abu&thread=39220&post=252)

Параметры:

* `board` — id доски.
* `thread` — id треда.
* `num` — порядковый номер поста в треде, начиная с корого будет список постов в ответе.

Ответ: Список объектов типа [`Post`](#post).

### Список тредов доски

`https://2ch.hk/<доска>/<номер-страницы>.json`

Параметры:

* `<номер-страницы>` — `index` для первой страницы, далее `1`, `2`, ...

```js
{
  "Board": "b",
  "BoardInfo": "",
  // И все остальные поля, как в ответе API "Список постов треда".
  "is_board": 1,
  "pages": [0, 1, 2, 3, ...], // Список страниц тредов доски.
  "threads": [{
    "files_count": 0, // Количество файлов, прикреплённых к постам треда (суммарно).
    "posts_count": 27, // Количество постов в треде.
    "thread_num": "3475861", // id треда. Почему-то в виде строки.
    "posts": [] // Список объектов типа `post`.
  }]
}
```

### Список тредов доски с сортировкой по дате последнего поста

[`https://2ch.hk/b/catalog.json`](https://2ch.hk/b/catalog.json)

Выводит список тредов, упорядоченных по дате "последнего" (на текущий момент) поста в них (самые новые — сверху).

`threads` — список "тредов", где "тред" — первый пост треда, то есть объект типа [`Post`](#post)

```js
{
  "Board": "b",
  "BoardInfo": "",
  // И все остальные поля, как в ответе API "Список постов треда".
  "threads": [] // Список объектов типа `Post`.
}
```

### Список тредов доски с сортировкой по времени создания треда

[`https://2ch.hk/b/catalog_num.json`](https://2ch.hk/b/catalog_num.json)

```js
{
  "Board": "b",
  "BoardInfo": "",
  // И все остальные поля, как в ответе API "Список постов треда".
  "threads": [] // Список объектов типа `Post`.
}
```

### Список тредов доски (облегченный вариант, с просмотрами и рейтингом для "топа тредов")

[`https://2ch.hk/b/threads.json`](https://2ch.hk/b/threads.json)

```js
{
  threads: [{
    "num": "3475861", // id треда.
    "score": 17.8347107438, // "Рейтинг" треда.
    "views": 2159, // Количество просмотров треда.
    "posts_count": 374, // Количество постов в треде.
    "timestamp": 1540597950, // Дата создания треда (unix timestamp).
    "subject": "Во что играем?", // Тема треда.
    "comment": "ИТТ описываем свои похождения, ...", // Первый пост треда.
    "lasthit": 1541028071, // Видимо, то же самое, что `lasthit` у объекта типа `Post`.
  },
  ...]
}
```

### Список досок

[`https://2ch.hk/boards.json`](https://2ch.hk/boards.json)

```js
{
  "global_boards": 158, // Количество досок.
  "global_posts": "363,061,097\u0000", // Количество постов на дваче.
  "global_speed": "1,406\u0000", // Количество постов на дваче в час.
  "is_index": 1, // Видимо, всегда `1`.
  "boards": [
    {
      "bump_limit": 500,
      "category": "Разное",
      "default_name": "Аноним",
      "enable_names": 0,
      "enable_sage": 1,
      "id": "b",
      "info": "бред",
      "last_num": 190778973,
      "name": "Бред",
      "speed": 2690, // Количество постов на доске в час.
      "threads": 210,
      "unique_posters": 4137
    },
    {
      "bump_limit": 500,
      "category": "Взрослым",
      "default_name": "Аноним",
      "enable_names": 1,
      "enable_sage": 1,
      "id": "fag",
      "info": "фагготрия, богини",
      "last_num": 6924268,
      "name": "Фагготрия",
      "speed": 734, // Количество постов на доске в час.
      "threads": 105,
      "unique_posters": 2194
    },
    ...
  ]
}
```

### Список "пользовательских" досок

https://2ch.hk/userboards.json

```js
{
  "boards": [{
    "id": "2d",
    "info": "Щитпостинг, обсуждение вайфу, аватарки и прочее. Анимешный /b/, постинг 3d не приветствуется.",
    "last_num": "793813",
    "name": "Аниме/Беседка",
    "speed": 15, // Количество постов на доске в час.
    "threads": 401
  },
  ...]
}
```

### Список досок (по категориям)

https://2ch.hk/makaba/mobile.fcgi?task=get_boards

```js
{
  "Взрослым": [{
    "bump_limit": 500,
    "category": "Взрослым",
    "default_name": "Аноним", // "уточка"
    "id": "fag",
    "name": "Фагготрия",
    "pages": 7,
    "icons": [{
      "name": "﻿Амкар",
      "num": 1,
      "url": "/icons/logos/amkar.png"
    }, ...]
  },
  ...],
  "Пользовательские": [{
    ...
  },
  ...],
  ...
}
```

### Поиск по всем постам доски

https://2ch.hk/makaba/makaba.fcgi

`FormData`:

* `board` — "b"
* `task` — "search"
* `find` — "текст"

## Прочее

### Разделы 18+

Доступ в разделы "18+" разрешён только для запросов, имеющих cookie `usercode_auth`. Эта cookie устанавливается сама при ответе в любой тред.

### Флаги

Если у доски `"enable_flags": 1` (например, на доске `/int/`), то у всех постов будет поле `icon`:

```js
{
  "icon": "<img hspace=\"3\" src=\"/flags/KR.png\" border=\"0\" />"
}
```

Есть пара странных флагов: `"A1.png"` и `"A2.png"`. Возможно, они для обозначения [Tor](https://ru.wikipedia.org/wiki/Tor)'а.

### Значки

На некоторых досках (например, `/po/`) у некоторых постов показываются значки (хз, по какому алгоритму они назначаются). Пример:

```js
{
  "icon": "<img hspace=\"3\" src=\"/icons/logos/gay.png\" title=\"ЛГБТ\" border=\"0\" />"
}
```

Один раз я видел исключение, когда это была не `.png` картинка. Этим исключением был значок Крыма: `krym.gif`.

### ID пользователей

На некоторых досках (например, `/po/`) показываются ID пользователей (являющиеся хешами их IP адресов). Хеш IP адреса будет представлен как в виде цвета автора сообщения, так и в виде самого случайно сгенерированного имени автора сообщения (у автора основного сообщения треда не будет цвета и имени). Примеры:

```js
{
  "name": "Аноним&nbsp;ID:&nbsp;Heaven"
}
```

```js
{
  "name": "Аноним&nbsp;ID:&nbsp;<span id=\"id_tag_7ab0a33a\" style=\"color:rgb(116,48,218);\">Насмешливый&nbsp;Обеликс</span>"
}
```

### Автогенерирование тем

На некоторых досках (например: `/b/`, `/rf/`) зачем-то нет поля "Темы" при создании треда или отправке сообщения. В этих случаях тема зачем-то генерируется сама. Судя по всему, алгоритм какой-то такой: все `<br>`'ы заменяются на пробелы, а все остальные теги — убираются.

```js
comment.replace(/<br>/g, ' ').replace(/<.+?>/g, '')
```

### Идентификация ОП

При создании темы можно ставить галку "ОП". В этом случае система запишет, что тред создан пользователем с таким-то хешем IP адреса. Если при ответе в такой тред снова поставить галку "ОП", и в случае, если хеш IP адреса отвечающего совпадёт с хешем IP адреса создавшего тред, то у поста будет поле `"op": 1`. Таким образом "ОП" (original poster) (автор треда) может идентифицировать себя в треде.

### Email

Автор сообщения может вписать в поле "Имя" свою почту, и тогда у поста будет поле `"email": "mailto:..."` с этим электронным адресом. Если в поле "Имя" было вписано ["sage"](https://knowyourmeme.com/memes/sage) (также называемая "сажей"), то у поста будет поле `"email": "mailto:sage"`, и такой пост не будет "бампать" (поднимать) тред.

### Трипкоды

Поле `trip` у поста.

"Трипкоды" привелегированных пользователей:

* `"!!%adm%!!"` — Администратор.
* `"!!%mod%!!"` — Модератор.

Обычные пользователи (т.н. "трипфаги") также могут использовать "трипкоды" для самоидентификации. Пример: `"!!5pvF7WEJc."`.

### Голоса

На некоторых досках (например, `/po/`) можно голосовать за посты. В этом случае у доски будет поле `enable_likes: 1`. У объекта Post в этом случае добавятся поля `likes: число` и `dislikes: число`.

### Стикеры.

Список стикеров - https://2ch.hk/makaba/stickers/

Добавить свой стикер пак - https://2ch.hk/makaba/stickers/editor

После создания стикер пака и загрузки изображений, необходимо нажать "Активировать", чтобы стикер пак был доступен всем для поиска.

Стикер паки владелец может обновлять, добавлять и удалять из них стикеры, а также удалить вовсе.
Измененный пак обновляется автоматически раз в сутки или можете обновить вручную, если видите что в нем появились новые изображения, нажав в окошке со стикерами U

Стикер вызывается через кнопку S в окошке поста.

Один пост = один стикер. Можно добавлять .gif, которые автоматически проигрываются в превью. .png автоматически отображаются прозрачными.

Стикеры доступны как для анонов (можно использовать до 5 паков), так и для пасскодобояр (без лимита).

Создавать паки могут абсолютно все.

Для загрузки изображение PNG/GIF должно вписываться в квадрат 512x512 (одна сторона — от 200 до 512 пикселей, другая — 512 или меньше, но не менее 50)