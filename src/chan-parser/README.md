Chan API response parser.

Supported engines:

* [4chan](https://github.com/4chan/4chan-API) ([4chan.org](https://www.4chan.org/)). See [`4chan.org` demo](https://catamphetamine.github.io/captchan/?chan=4chan).
* [vichan](https://github.com/vichan-devel/vichan)/[infinity](https://github.com/ctrlcctrlv/infinity)/[OpenIB](https://github.com/OpenIB/OpenIB/) ([8ch.net](https://8ch.net/)). See [`8ch.net` demo](https://catamphetamine.github.io/captchan/?chan=8ch).
* [lynxchan](https://gitgud.io/LynxChan/LynxChan) ([kohlchan.net](https://kohlchan.net), [endchan.xyz](https://endchan.xyz)). See: [`kohlchan.net` demo](https://catamphetamine.github.io/captchan/?chan=kohlchan), [`endchan.xyz` demo](https://catamphetamine.github.io/captchan/?chan=endchan).
* [makaba](https://2ch.hk/api/) ([2ch.hk](https://2ch.hk/)). See [`2ch.hk` demo](https://catamphetamine.github.io/captchan/?chan=2ch).

Features:

* Parses chan comments HTML into structured JSON documents.
* Automatically inserts quoted posts' text when none provided.

```js
import createParser from './chan-parser'
```

### createParser(chanIdOrChanSettings, options)

Creates a new parser instance.

If a `chanId` is supported by the library out-of-the-box (has an entry in `chan` directory) then those pre-configured `chanSettings` are used. Otherwise, `chanSettings` should be supplied.

`chanId`s supported out-of-the-box:

* `"2ch"`
* `"4chan"`
* `"8ch"`
* `"kohlchan"`

Available `chanSettings`:

* `id` — (optional) Chan identifier that could be used to differentiate between different chans using the same parser. For example, `4chan.org` parser is compatible with `8ch.net` and the small differences are handled as `if (id === "8ch") { ... } else { ... }`.
* `commentUrlRegExp` — (required) A `string` used to parse "in reply to" comment ids from comment HTML content to populate `comment.inReplyTo` arrays.
* `defaultAuthorName` — (optional) Can be a `string` or an object of shape `{ boardId: defaultName }` where `boardId === "*"` means "any other board". Default author name is used to determine whether a comment's `authorName` should be set to `undefined` instead of a dummy string value (for example, `"Anonymous"`).
* `attachmentUrl` — (required for `"4chan"` parser) A `string` having variables: `{boardId}`, `{name}`, `{originalName}`, `{ext}`.
* `attachmentThumbnailUrl` — (required for `"4chan"` parser) Same as `attachmentUrl` but for the thumbnail.
* `fileAttachmentUrl` — (optional) Can be present if file attachment URLs are different from generic attachment URLs for some reason (for example, `4chan.org` hosts file attachments using their "original names" instead of autogenerated ones as it does for pictures).
* `attachmentUrlFpath` — (is only used by `8ch.net`) `8ch.net` has `fpath: 0/1` parameter for attachments: `fpath` attachments are hosted at the global board-agnostic `fpath` URLs (not having `boardId` as part of their URL) and all other attachments are hosted at board-specific URLs.
* `attachmentThumbnailUrlFpath` — (is only used by `8ch.net`) Thumnail for `attachmentUrlFpath`.
* `parser` — (optional) In case of parsing a chan which isn't supported out-of-the-box `parser` parameter can be passed to tell the library to use a specific parser from `./src/chan-parser/parser` for parsing the chan. Example: `"4chan"`.

Available `options`:

* `getUrl(board, thread, comment)` — (required) `chan-parser` transforms all links to posts and threads by replacing their URLs (for example, `http://boards.4channel.org/v/thread/467643418#q467643687`) with custom URLs generated by this `getUrl()` function (for example, `/v/467643418#467643687`).

* `messages` — (optional) `messages` are mostly used for setting post link content. Examples: `messages.deletedComment === "Comment deleted"`, `messages.hiddenComment === "Hidden comment"`, `messages.quotedComment === "Comment"`.

* `censoredWords` — (optional) An array of pre-compiled word filters which can be used for censoring certain words in comments' content or subject. The word filters must be pre-compiled via `compileWordPatterns(censoredWords, language)` where `compileWordPatterns` is a function exported from this package. `language` argument can be either `"en"` or `"ru"` or `"de"` (more languages can be added) and is only used for finding word boundaries. `censoredWords` argument passed to `compileWordPatterns()` must be an array of `string` patterns. The standard regular expression syntax applies (`^` meaning "word start", `$` meaning "word end", `.` meaning "any letter", etc). Example: `^mother.*$`, `fc?uck`.

* `commentLengthLimit` — (optional) A `number` telling the maximum comment length (in "points" which can be thought of as "characters and character equivalents for non-text content") upon exceeding which a preview is generated for a comment (as `comment.contentPreview`).

* `useRelativeUrls` — (optional) Determines whether to use relative or absolute URLs for attachments. Relative URLs are for the cases when a chan is temporarily hosted on an alternative domain and so all attachments are too meaning that the default chan domain name shouldn't be present in attachment URLs. Is `false` by default.

* `parseContent` — (optional) Can be set to `false` to skip parsing comment HTML (except for the "opening" post of the thread which is always parsed up-front because it makes sense). The rationale is that when there're 500-some comments in a thread parsing all of them can take up to a second on a modern CPU which results in a subpar user experience. By deferring parsing comment HTML an application can first only parse, say, the first 10 comments' HTML and only when the page has been loaded it can proceed to parsing the rest of the comments (maybe even just the next 10 comments until the user scrolls down). If `parseContent` is set to `false` then each comment will have `.parseContent()` method that should be called to parse comment content on demand.

<!--
* `parseContentText` — (optional) Set to `true` to also parse `contentText` when parsing `content`. This can be used, for example, for full-text search.
-->

* `addOnContentChange` — (optional) Adds `onContentChange()` functions to each comment. The `onContentChange()` function should be called whenever the comment content is updated (for example, after a link to a YouTube video is parsed and expanded into an embedded attachment). It re-generates comment preview and also if `expandReplies` is `true` it updates the autogenerated quotes in the comment's replies. Returns an array of ids of replies to this comment whos content did change as a result of this comment content's change. For example, when there're replies to this comment having autogenerated quotes those quotes should be re-generated when this comment's content changes.

* `expandReplies` — (optional) Set to `true` to expand the optional `comment.replies[]` array from a list of comment ids to the list of the actual comment objects.

### Parser.parseBoards(apiResponse)

Parses a list of [Boards](#board).

```js
{
	boards: Board[],
	// (optional)
	boardsByPopularity: Board[],
	// (optional)
	boardsByCategory: {
		'Category': Board[],
		...
	}
}
```

### Parser.parseThreads(apiResponse, { boardId })

Parses board contents. Returns a list of [Threads](#thread).


### Parser.parseThread(apiResponse, { boardId })

Parses a thread (having a list of [comments](#comment)). Returns a [Thread](#thread).

## Content

A post can have `content` and sometimes `contentPreview` both of which are [`Content`](https://github.com/catamphetamine/webapp-frontend/tree/master/src/utility/post/PostContent.md).

## Attachment

An attachment can be a:

* [`Picture`](https://github.com/catamphetamine/webapp-frontend/tree/master/src/utility/post/PostAttachments.md#picture) attachment

<!--
Additional fields:

```js
{
	// (only for `2ch.hk`)
	// `true` in case of a `2ch.hk` sticker.
	sticker: boolean?
}
```
-->

* [`Video`](https://github.com/catamphetamine/webapp-frontend/tree/master/src/utility/post/PostAttachments.md#video) attachment

* [`File`](https://github.com/catamphetamine/webapp-frontend/tree/master/src/utility/post/PostAttachments.md#file) attachment

## Comment

```js
{
	// Comment ID.
	id: number,
	// Board ID.
	// Example: "b".
	boardId: string,
	// Thread ID.
	threadId: number,
	// Comment title ("subject").
	title: string?,
	// If `title` contains ignored words then a censored title
	// containing "censored" "spoilers" will be generated.
	titleCensored: InlineContent?,
	// The date on which the comment was posted.
	createdAt: Date,
	// A "tripcode".
	// https://encyclopediadramatica.rs/Tripcode
	tripCode: String?,
	// `2ch.hk` provides means for "original posters" to identify themselves
	// when replying in their own threads with a previously set "OP" cookie.
	isThreadAuthor: boolean?,
	// Some chans identify their users by a hash of their IP address subnet
	// on some of their boards (for example, all chans do that on `/pol/` boards).
	authorId: String?,
	// If `authorId` is present then it's converted into a HEX color.
	// Example: "#c05a7f".
	authorIdColor: String?,
	// Comment author name.
	authorName: String?,
	// `2ch.hk` autogenerates names based on IP address subnet hash on `/po` board.
	// If this flag is `true` then it means that `authorName` is an equivalent of an `authorId`.
	authorNameId: boolean?,
	// A two-letter ISO country code (or "ZZ" for "Anonymized").
	// Chans usually show poster flags on `/int/` boards.
	authorCountry: String?,
	// Some chans allow icons for posts on some boards.
	// For example, `kohlchan.net` shows user icons on `/int/` board.
	// Author icon examples in this case: "UA", "RU-MOW", "TEXAS", "PROXYFAG", etc.
	// `authorIconUrl` is `/.static/flags/${authorIcon}.png`.
	// `authorIconName` examples in this case: "Ukraine", "Moscow", "Texas", "Proxy", etc.
	// Also, `2ch.hk` allows icons for posts on various boards like `/po/`.
	// Author icon examples in this case: "nya", "liber", "comm", "libertar", etc.
	// `authorIconUrl` is `/icons/logos/${authorIcon}.png`.
	// `authorIconName` examples in this case: "Nya", "Либерализм", "Коммунизм", "Либертарианство", etc.
	authorIconUrl: String?,
	authorIconName: String?,
	// If the comment was posted by a "priviliged" user
	// then it's gonna be the role of the comment author.
	// Examples: "administrator", "moderator".
	authorRole: String?,
	// If `true` then it means that the author was banned for the message.
	authorBanned: boolean?,
	// An optional `String` with the ban reason.
	authorBanReason: String?,
	// Downvotes count for this comment.
	// Only for boards like `/po/` on `2ch.hk`.
	upvotes: number?,
	// Downvotes count for this comment.
	// Only for boards like `/po/` on `2ch.hk`.
	downvotes: number?,
	// Comment content.
	// Example: `[['Text']]`.
	content: Content?,
	// If the `content` is too long a preview is generated.
	contentPreview: Content?,
	// Comment attachments.
	attachments: Attachment[]?,
	// The IDs of the comments to which this comment replies.
	inReplyTo: number[]?,
	// The IDs of the comments which are replies to this comment.
	replies: number[]?
}
```

## Thread

```js
{
	// Thread ID.
	// Same as the "id" of the first comment.
	id: number,
	// Board ID.
	// Example: "b".
	boardId: string,
	// Comments count in this thread.
	// (not including the main comment of the thread).
	commentsCount: number,
	// Attachments count in the comments of this thread.
	// (doesn't include the main comment of the thread).
	commentAttachmentsCount: number,
	// Thread title ("subject").
	// Either the first comment's `title` or is
	// autogenerated from the first comment's content.
	title: string?,
	// Comments in this thread.
	// (including the main comment of the thread).
	comments: Comment[],
	// Is this thread "sticky" (pinned).
	isSticky: boolean?,
	// Is this thread locked.
	isLocked: boolean?,
	// A "rolling" thread is the one where old messages are purged as new ones come in.
	isRolling: boolean?,
	// Was the "bump limit" reached for this thread already.
	// Is `false` when the thread is "sticky" or "rolling"
	// because such threads don't expire.
	isBumpLimitReached: boolean?,
	// `4chan.org` sets a limit on maximum attachments count in a thread.
	isAttachmentLimitReached: boolean?,
	// Maximum comment length in a thread on the board
	// when posting a new comment/thread (a board-wide setting).
	// Is only present on threads on `2ch.hk`.
	// `4chan.org` has it on boards.
	maxCommentLength: number?,
	// Maximum total attachments size in a thread on the board (a board-wide setting).
	// Is only present on threads on `2ch.hk`.
	// `4chan.org` has it on boards.
	maxAttachmentsSize: number?,
	// "Last Modified Date", including: replies, deletions, sticky/closed status changes.
	// Only present for `4chan.org`.
	lastModifiedAt: Date?,
	// Custom spoiler ID (if custom spoilers are used on the board).
	// Only present for `4chan.org`.
	customSpoilerId: number?,
	// Unique poster IP address subnets count.
	// Only present in "get thread" API response.
	uniquePostersCount: number?
}
```

## Board

```js
{
	// Board ID.
	// Example: "b".
	id: string,
	// Board title.
	// Example: "Anime & Manga".
	title: string,
	// Board description.
	description: string,
	// Is this board "Not Safe For Work".
	isNotSafeForWork: boolean?,
	// "Bump limit" for threads on this board.
	bumpLimit: number?,
	// The maximum attachments count in a thread.
	// Only present for 4chan.org
	attachmentLimit: number?,
	// Maximum comment length in a thread on the board (a board-wide setting).
	// Only present for `4chan.org`.
	maxCommentLength: number?,
	// Maximum total attachments size in a thread on the board (a board-wide setting).
	// Only present for `4chan.org`.
	maxAttachmentsSize: number?,
	// Maximum total video attachments size in a thread on the board (a board-wide setting).
	// Only present for `4chan.org`.
	maxVideoAttachmentsSize: number?,
	// Create new thread cooldown.
	// Only present for `4chan.org`.
	createThreadCooldown: number?,
	// Post new comment cooldown.
	// Only present for `4chan.org`.
	replyCooldown: number?,
	// Post new comment with an attachment cooldown.
	// Only present for `4chan.org`.
	attachFileCooldown: number?,
	// Whether "sage" is allowed when posting comments on this board.
	// Only present for `4chan.org`.
	isSageAllowed: boolean?,
	// Whether to show a "Name" field in a "post new comment" form on this board.
	// Only present for `2ch.hk`.
	showNames: boolean?
}
```

## Adding a new chan

* Create the chan's directory in `./src/chan-parser/chan`.
* Create `index.json` and `index.js` files in the chan's directory (see other chans as an example).
* Add an export for the chan in `./src/chan-parser/chan/index.js` (same as for the existing chans).

<details>
<summary><code>index.json</code> format</summary>

###

```js
{
	// (required)
	// Chan unique ID.
	"id": "4chan",

	// (required)
	// Chan website URL.
	"url": "https://www.4chan.org",

	// (optional)
	// Chan engine.
	// Isn't currently being used anywhere.
	"engine": "vichan",

	// (required)
	// Comment URL pattern.
	// Is used for parsing quoted comment URLs.
	// The first "group" must match board id,
	// the second "group" must match thread id,
	// the third "group" must match comment id.
	"commentUrlRegExp": "^\\/(.+?)\\/res\\/(\\d+).html#(\\d+)$"

	// (optional)
	// Attachment URL pattern.
	// Is required for chan engines that don't
	// provide the full attachment URL (`vichan`)
	// or for chans that host attachments on another domain
	// (`4chan` hosts attachments at `https://i.4cdn.org`).
	// Available parameters are:
	// * boardId — board ID ("b", etc).
	// * name — attachment filename on server.
	// * originalName — original attachment filename, is used for non-image file attachments.
	// * ext — "." character plus attachment file extension.
	"attachmentUrl": "https://i.4cdn.org/{boardId}/{name}{ext}",

	// (optional)
	// Attachment thumbnail URL pattern.
	// Same as "attachmentUrl" but for thumbnails.
	"attachmentThumbnailUrl": "https://i.4cdn.org/{boardId}/{name}s.jpg",

	// (optional)
	// Chans usually store images/videos under random-generated filenames
	// and all other files under their original filename,
	// hence the separate "fileAttachmentUrl" parameter.
	"fileAttachmentUrl": "https://i.4cdn.org/{boardId}/{originalName}{ext}",

	// (optional)
	// Most chans set author name to some default placeholder
	// like "Anonymous" when no author name has been input.
	// The parser then checks if author name is equal to
	// "defaultAuthorName" and if it is then it assumes it's empty.
	// Can be a string or an object of shape `{ boardId: defaultAuthorName }`.
	"defaultAuthorName": "Anonymous",
	// or on a per-board basis:
	// "defaultAuthorName": {
	// 	"*": "Anonymous",
	// 	"ru": "Аноним",
	// 	"christan": "Christanon"
	// }

	// (optional)
	// Thumbnail size. Is required for `lynxchan`.
	// `lynxchan` engine currently has a bug:
	// it doesn't provide thumbnail dimensions.
	// To work around that bug, thumbnail dimensions
	// are derived from the original image aspect ratio.
	"thumbnailSize": 255
}
```
</details>

###

If the chan runs on an already supported engine then it most likely has its own comment HTML syntax which could be different from other chans running on the same engine. In such case, go to the engine parser's directory (`./src/chan-parser/parser/${parserName}`) and edit `Parser.js` file to use the set of ["comment parser plugins"](#comment-parser-plugins) specific to this new chan (see other chan's comment parser plugins as an example). Otherwise, if it's a new engine:

* Create the engine parser directory in `./src/chan-parser/parser`.
* Create `Parser.js` file in the engine parser directory (same as for the existing engine parsers). The `Parser` class must extend `./src/chan-parser/Parser.js` and implement three methods (`parseBoards()`, `parseThreads()` and `parseThread()`) and also provide a list of HTML ["comment parser plugins"](#comment-parser-plugins) (see other engine parsers as an example).
* Add the engine parser in `./src/chan-parser/parser/index.js` (same as for the existing engine parsers).

## Comment parser plugins

Chan comments are formatted in HTML. Different chans use their own comment HTML syntax. For example, bold text could be `<strong>bold</strong>` at some chans, `<b>bold</b>` at other chans and `<span class="bold">bold</span>` at the other chans, even if they all used the same engine. Hence, every chan requires defining their own set of "comment parser plugins" in `./src/chan-parser/parser/${engine}` directory.

A "comment parser plugin" is an object having properties:

* `tag: String` — HTML tag (in lower case).
* `attributes: object[]?` — A set of HTML tag attribute filters. An attribute filter is an object of shape `{ name: String, value: String }`.
* `createBlock(content: PostContent, node, options): PostContent?` — Receives child `content` and wraps it in a parent content block (see [Post Content](https://github.com/catamphetamine/webapp-frontend/blob/master/src/utility/post/PostContent.md) docs). Can return `undefined`. Can return a string, an object or an array of strings or objects. `node` is the DOM `Node` and provides methods like `getAttribute(name: String)`. `options` is an object providing some configuration options like `commentUrlRegExp` for parsing comment links (`<a href="/b/123#456">&gt;&gt;456</a>`).

Example:

```html
<strong>bold <span class="italic">text</span></strong>
```

Plugins:

```js
const parseBold = {
	tag: 'strong',
	createBlock(content) {
		return {
			type: 'text',
			style: 'bold',
			content
		}
	}
}

const parseItalic = {
	tag: 'span',
	attributes: [{
		name: 'class',
		value: 'italic'
	}],
	createBlock(content) {
		return {
			type: 'text',
			style: 'italic',
			content
		}
	}
}

export default [
	parseBold,
	parseItalic
]
```

Result:

```js
[
	[
		{
			type: 'text',
			style: 'bold',
			content: [
				'bold ',
				{
					type: 'text',
					style: 'italic',
					content: 'text'
				}
			]
		}
	]
]
```